<div *ngIf="createVM || editVM"
    style="position: absolute;z-index:11;width:100%; height:100%; background-color:rgba(37, 37, 37, 0.623);overflow:hidden;">
</div>




<!-- master view   -->
<div class="container" style="padding: 10px;">
    <mat-card>
        <h2 style="float:left">VMs/Credits</h2>

        <div style="clear:both;"></div>
        <div class="row">

            <div class="col-md-4 coldash1">
                <div style="font-size:22px;">Active:
                    <div>{{machines?.length}} VMs</div>
                </div>
            </div>
            <div class="col-md-4 coldash2">

                <div style="font-size:22px;">Running:
                    <div>{{machines?.length-stopped}} VMs</div>
                    <!-- <div [innerHTML]="(creditssum  | number:'1.2':'en') | amount: creditssum"></div> -->
                </div>

            </div>
            <div class="col-md-4 coldash3">
                <div style="font-size:22px;">Stopped:
                    <div>{{stopped}} VMs</div>
                    <!-- <div [innerHTML]="(creditsusedsum  | number:'1.2':'en') | amount: creditsusedsum"></div> -->
                </div>
            </div>


        </div>
    </mat-card>

    <div class="gap10"></div>

    <div class="filter-bar">
        <mat-form-field appearance="outline" class="filter-input">
            <mat-label>Filter by name, type, region…</mat-label>
            <input matInput [value]="filterText" (input)="onFilterChange($event.target.value)" />
            <button *ngIf="filterText" matSuffix mat-icon-button aria-label="Clear filter"
                (click)="onFilterChange('')">
                <mat-icon>close</mat-icon>
            </button>
        </mat-form-field>
    </div>

    <mat-card class="cloud-machines-card">
        <div class="cloud-machines-header">
            <h3>Compute Engine Machines</h3>
            <div class="cloud-machines-actions">
                <mat-form-field appearance="outline" class="tab-select" *ngIf="filteredCloudRegions.length">
                    <mat-label>Region</mat-label>
                    <mat-select [value]="selectedCloudRegionIndex" (selectionChange)="onCloudRegionSelect($event.value)">
                        <mat-option *ngFor="let region of filteredCloudRegions; let i = index" [value]="i">
                            {{ formatRegionLabel(region.region) }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <button mat-stroked-button color="primary" (click)="loadCloudMachines()" [disabled]="cloudMachinesLoading">
                    {{ cloudMachinesLoading ? 'Loading…' : 'Refresh' }}
                </button>
            </div>
        </div>
        <div class="cloud-machines-meta" *ngIf="cloudMachinesLastUpdated">
            Last updated {{ cloudMachinesLastUpdated | date:'medium' }} · {{ totalCloudMachines }} total
        </div>
        <div class="cloud-machines-error" *ngIf="cloudMachinesError">{{ cloudMachinesError }}</div>
        <ng-container *ngIf="!cloudMachinesError">
            <div class="cloud-machines-loading" *ngIf="cloudMachinesLoading">
                Loading Compute Engine machines…
            </div>
            <ng-container *ngIf="!cloudMachinesLoading">
                <p class="cloud-machines-empty" *ngIf="!filteredCloudRegions.length">
                    No Compute Engine machines were returned.
                </p>
                <mat-tab-group *ngIf="filteredCloudRegions.length" mat-stretch-tabs
                    [selectedIndex]="selectedCloudRegionIndex" (selectedIndexChange)="onCloudRegionTabChange($event)">
                    <mat-tab *ngFor="let region of filteredCloudRegions"
                        [label]="formatRegionLabel(region.region) + ' (' + countMachinesForRegion(region) + ')'">
                        <div class="region-content">
                            <div *ngFor="let zone of region.zones" class="zone-section">
                                <h4>{{ formatZoneLabel(zone.zone) }} · {{ countMachinesForZone(zone) }} machines</h4>
                                <table class="table table-alternate table-hover vm-table">
                                    <thead>
                                        <tr>
                                            <th>
                                                <button type="button" class="sortable-header"
                                                    (click)="setCloudSort('name')">
                                                    Name
                                                    <mat-icon *ngIf="cloudSortColumn === 'name'">
                                                        {{ cloudSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                                                    </mat-icon>
                                                </button>
                                            </th>
                                            <th>
                                                <button type="button" class="sortable-header"
                                                    (click)="setCloudSort('status')">
                                                    Status
                                                    <mat-icon *ngIf="cloudSortColumn === 'status'">
                                                        {{ cloudSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                                                    </mat-icon>
                                                </button>
                                            </th>
                                            <th>
                                                <button type="button" class="sortable-header"
                                                    (click)="setCloudSort('type')">
                                                    Machine Type
                                                    <mat-icon *ngIf="cloudSortColumn === 'type'">
                                                        {{ cloudSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                                                    </mat-icon>
                                                </button>
                                            </th>
                                            <th>
                                                <button type="button" class="sortable-header"
                                                    (click)="setCloudSort('ip')">
                                                    IPs
                                                    <mat-icon *ngIf="cloudSortColumn === 'ip'">
                                                        {{ cloudSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                                                    </mat-icon>
                                                </button>
                                            </th>
                                            <th>
                                                <button type="button" class="sortable-header"
                                                    (click)="setCloudSort('created')">
                                                    Created
                                                    <mat-icon *ngIf="cloudSortColumn === 'created'">
                                                        {{ cloudSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                                                    </mat-icon>
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let machine of zone.machines">
                                            <td>{{machine.name}}</td>
                                            <td>{{machine.status || '—'}}</td>
                                            <td>{{formatMachineType(machine.machineType)}}</td>
                                            <td>
                                                <div *ngIf="machine.internalIp">Internal: {{machine.internalIp}}</div>
                                                <div *ngIf="machine.externalIp">External: {{machine.externalIp}}</div>
                                                <div *ngIf="!machine.internalIp && !machine.externalIp">—</div>
                                            </td>
                                            <td>{{machine.creationTimestamp | date:'short'}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </mat-tab>
                </mat-tab-group>
            </ng-container>
        </ng-container>
    </mat-card>

    <div class="gap10"></div>

    <mat-card class="pricing-summary-card" *ngIf="catalogSummary">
        <div class="cloud-machines-header">
            <h3>Pricing Overview</h3>
        </div>
        <div class="pricing-grid">
            <div>
                <div class="pricing-value">{{ catalogSummary.totalTypes | number }}</div>
                <div class="pricing-label">Machine types</div>
            </div>
            <div>
                <div class="pricing-value">{{ catalogSummary.pricedTypes | number }}</div>
                <div class="pricing-label">With pricing ({{ catalogSummary.pricedPercentage }}%)</div>
            </div>
            <div>
                <div class="pricing-value">{{ catalogSummary.missingTypes | number }}</div>
                <div class="pricing-label">Missing prices</div>
            </div>
            <div>
                <div class="pricing-value">{{ catalogSummary.pricedFamilies }}/{{ catalogSummary.familyCount }}</div>
                <div class="pricing-label">Series covered</div>
            </div>
            <div>
                <div class="pricing-value">
                    <ng-container *ngIf="catalogSummary.priceReleaseDate; else noRelease">
                        {{ catalogSummary.priceReleaseDate | date:'medium' }}
                    </ng-container>
                    <ng-template #noRelease>Unknown</ng-template>
                </div>
                <div class="pricing-label">Pricing release</div>
            </div>
        </div>
        <div class="missing-families" *ngIf="catalogSummary.missingFamilies">
            <strong>Families missing pricing (sample):</strong>
            <span>{{ catalogSummary.missingFamilySamples.join(', ') || '—' }}</span>
        </div>
    </mat-card>

    <div class="gap10"></div>

    <mat-card class="machine-catalog-card">
        <div class="cloud-machines-header">
            <h3>Google Machine Catalog</h3>
            <div class="cloud-machines-actions">
                <mat-form-field appearance="outline" class="tab-select" *ngIf="filteredCatalogRegions.length">
                    <mat-label>Region</mat-label>
                    <mat-select [value]="selectedCatalogRegionIndex"
                        (selectionChange)="onCatalogRegionSelect($event.value)">
                        <mat-option *ngFor="let region of filteredCatalogRegions; let i = index" [value]="i">
                            {{ formatRegionLabel(region.region) }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <button mat-stroked-button color="primary" (click)="loadMachineCatalog()" [disabled]="machineCatalogLoading">
                    {{ machineCatalogLoading ? 'Loading…' : 'Refresh' }}
                </button>
            </div>
        </div>
        <div class="cloud-machines-meta" *ngIf="machineCatalogLastUpdated">
            Last updated {{ machineCatalogLastUpdated | date:'medium' }} · {{ totalMachineCatalog }} types
            <ng-container *ngIf="machineCatalogPriceRelease">
                · pricing as of {{ machineCatalogPriceRelease | date:'mediumDate' }}
            </ng-container>
        </div>
        <div class="cloud-machines-error" *ngIf="machineCatalogError">{{ machineCatalogError }}</div>
        <ng-container *ngIf="!machineCatalogError">
            <div class="cloud-machines-loading" *ngIf="machineCatalogLoading">
                Loading machine catalog…
            </div>
            <div class="catalog-controls" *ngIf="!machineCatalogLoading">
                <mat-form-field appearance="outline" class="catalog-filter-input">
                    <mat-label>Filter by name or notes</mat-label>
                    <input matInput [value]="catalogFilterText"
                        (input)="onCatalogFilterChange($event.target.value)" />
                    <button *ngIf="catalogFilterText" matSuffix mat-icon-button aria-label="Clear catalog filter"
                        (click)="onCatalogFilterChange('')">
                        <mat-icon>close</mat-icon>
                    </button>
                </mat-form-field>
                <mat-checkbox [checked]="catalogShowOnlyPriced"
                    (change)="onCatalogShowOnlyPricedChange($event.checked)">
                    Only show priced entries
                </mat-checkbox>
            </div>
            <ng-container *ngIf="!machineCatalogLoading">
                <p class="cloud-machines-empty" *ngIf="!filteredCatalogRegions.length">
                    No machine types were returned for this project.
                </p>
                <mat-tab-group *ngIf="filteredCatalogRegions.length" mat-stretch-tabs
                    [selectedIndex]="selectedCatalogRegionIndex"
                    (selectedIndexChange)="onCatalogRegionTabChange($event)">
                    <mat-tab *ngFor="let region of filteredCatalogRegions"
                        [label]="formatRegionLabel(region.region) + ' (' + countCatalogForRegion(region) + ')'">
                        <div class="region-content">
                            <div *ngFor="let zone of region.zones" class="zone-section">
                                <h4>{{ formatZoneLabel(zone.zone) }} · {{ countCatalogForZone(zone) }} machine types</h4>
                                <table class="table table-alternate table-hover vm-table">
                                    <thead>
                                        <tr>
                                            <th>
                                                <button type="button" class="sortable-header"
                                                    (click)="setCatalogSort('name')">
                                                    Name
                                                    <mat-icon *ngIf="catalogSortColumn === 'name'">
                                                        {{ catalogSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                                                    </mat-icon>
                                                </button>
                                            </th>
                                            <th>
                                                <button type="button" class="sortable-header"
                                                    (click)="setCatalogSort('vcpu')">
                                                    vCPU
                                                    <mat-icon *ngIf="catalogSortColumn === 'vcpu'">
                                                        {{ catalogSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                                                    </mat-icon>
                                                </button>
                                            </th>
                                            <th>
                                                <button type="button" class="sortable-header"
                                                    (click)="setCatalogSort('memory')">
                                                    Memory
                                                    <mat-icon *ngIf="catalogSortColumn === 'memory'">
                                                        {{ catalogSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                                                    </mat-icon>
                                                </button>
                                            </th>
                                            <th>
                                                <button type="button" class="sortable-header"
                                                    (click)="setCatalogSort('hourly')">
                                                    Hourly (USD)
                                                    <mat-icon *ngIf="catalogSortColumn === 'hourly'">
                                                        {{ catalogSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                                                    </mat-icon>
                                                </button>
                                            </th>
                                            <th>
                                                <button type="button" class="sortable-header"
                                                    (click)="setCatalogSort('monthly')">
                                                    Monthly (USD)
                                                    <mat-icon *ngIf="catalogSortColumn === 'monthly'">
                                                        {{ catalogSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                                                    </mat-icon>
                                                </button>
                                            </th>
                                            <th>
                                                <button type="button" class="sortable-header"
                                                    (click)="setCatalogSort('notes')">
                                                    Notes
                                                    <mat-icon *ngIf="catalogSortColumn === 'notes'">
                                                        {{ catalogSortDirection === 'asc' ? 'arrow_upward' : 'arrow_downward' }}
                                                    </mat-icon>
                                                </button>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let machineType of zone.machineTypes">
                                            <td>
                                                {{machineType.name}}
                                                <span *ngIf="isDeprecated(machineType)" class="deprecated-tag">Deprecated</span>
                                            </td>
                                            <td>{{machineType.guestCpus ?? '—'}}</td>
                                            <td>{{formatMemory(machineType.memoryGb)}}</td>
                                            <td>{{formatPrice(machineType.pricePerHourUsd)}}</td>
                                            <td>{{formatMonthlyPrice(machineType.pricePerMonthUsd)}}</td>
                                            <td>{{machineType.description || '—'}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </mat-tab>
                </mat-tab-group>
            </ng-container>
        </ng-container>
    </mat-card>

    <div class="gap10"></div>

    <mat-card>
        <!-- <h1 class="mat-h1">Projekte</h1> -->

        <!-- <table class="table table-alternate table-hover">

            <thead>
                <tr>
                    <th>VM Name</th>
                    <th>State</th>
                    <th>Credits</th>
                    <th>Credits Used</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody *ngIf="vms">
                <tr *ngFor="let p of vms">
                      <td>{{p.name}}</td>
                    <td style="font-weight: bold;">{{p.metadata.status}}</td>
                     <td style="font-weight: bold;">{{p.metadata.machineType}}</td>
                    <td><a [routerLink]="'/customer'" [queryParams]="{id: p.id}"
                            class="btn btn-outline-secondary btn-sm ">details</a></td>
                    <td style="color:gray;">{{p.notes}}</td>
                    <td>
              
                    </td>

                </tr>
            </tbody>
        </table> -->

        <table class="table table-alternate table-hover">

            <thead>
                <tr>
                    <th>Machinename</th>
                    <th>Times</th>
                    <th>Date</th>
                    <th>State</th>
                    <th>Credits Used</th>
                    <th></th>
                </tr>
            </thead>
            <tbody *ngIf="machines">
                <tr *ngFor="let p of machines">
                    <!-- <td><a [routerLink]="'/kunde/'+ p.Kunde">{{p.DashBoard?.Kunde}}</a></td> -->
                    <td>
                        {{p.machinename}}
                        <!-- {{p.cid}}<br> -->
                        <!-- {{p.vmname}} -->
                    </td>
                    <!-- <td style="font-weight: bold;">{{p.ip6}}</td> -->

                    <td>
                        Start: {{p.startTime|date:'yy.M.d, h:mm:ss a'}}<br>
                        End: {{p.endtime|date:'yy.M.d, h:mm:ss a'}}

                        {{p|json}}

                    </td>


                    <!-- <td>{{p.creditors}} €</td> -->
                    <td style="font-weight: bold;">{{p.datetime|date:'short'}}</td>
                    <td style="font-weight: bold;">
                        {{p.state}}<br>
                        <div style="font-weight:normal;">{{p.lastlog}}</div>
                    </td>
                    <td>
                        <a [routerLink]="'/vms/'+p.machinename" class="btn btn-outline-secondary btn-sm ">details</a>
                        <a (click)="removevm(p.id)" class="btn btn-outline-warning btn-sm "
                            style="margin-left:10px;">remove</a>
                    </td>

                    <td style="color:gray;"></td>

                    <td>
                        <!-- <button class="btn btn-outline-secondary btn-sm " (click)="showEditDlg(p)"
                            style="margin-left:10px;"> set credits </button> -->


                        <!-- <button class="btn btn-outline-secondary btn-sm " [mdePopoverTriggerFor]="appPopover"
                            style="margin-left:10px;" mdePopoverTriggerOn="click"> delete </button> -->
                        <!-- <mde-popover #appPopover="mdePopover" [mdePopoverOverlapTrigger]="false">
                            <mat-card style="max-width: 300px">
                                <mat-card-content>
                                    <a mat-button routerLink=".">cancel</a>
                                    <button mat-flat-button color="warn" (click)="deleteCustomer(p.id)"
                                        style="margin-left:10px;">
                                        delete
                                    </button>
                                </mat-card-content>
                            </mat-card>
                        </mde-popover> -->


                    </td>

                </tr>
            </tbody>
        </table>

    </mat-card>
</div>
